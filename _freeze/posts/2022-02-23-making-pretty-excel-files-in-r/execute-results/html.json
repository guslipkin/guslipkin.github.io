{
  "hash": "574fb3fafc69e9ad8cbf72eaa6a74749",
  "result": {
    "markdown": "---\ntitle: \"Making Pretty Excel Files in R\"\ndescription: \"Using the openxlsx package in R and RStudio to make formatted Excel files\"\nauthor: \"Gus Lipkin\"\ndate: \"2022/02/23\"\ncategories:\n  - R\n  - \"R: openxlsx\"\n  - Excel\nformat:\n  html:\n    theme: default\n    toc: true\n---\n\n\n[*Link to the Medium post*](https://guslipkin.medium.com/making-pretty-excel-files-in-r-46a15c7a2ee8)\n\n# Intro\n\nIt's a tale as old as time. Your boss gave you a bunch of Excel files and you painstakingly made a bot that will import and display them in a Shiny dashboard. Proud of your work, you take it to your boss and they say \"I don't know what a 'Shiny' is, can't you just give me one of those Excels back?\" `openxlsx` makes this easy.\n\nToday we're going to recreate an existing workbook with `openxlsx.` To get started, I made a small `.xlsx` file for us to work with that can be downloaded [here](../assets/post-assets/2022-02-23-making-pretty-excel-files-in-r/bbq.xlsx). It's an attendance list and some notes on supplies you'll need for a company barbecue. Feel free to get familiar with it then come back here when you're ready.\n\n::: {#fig-grouped-stacked layout-ncol=2}\n\n![The `attendance` sheet](../assets/post-assets/2022-02-23-making-pretty-excel-files-in-r/attendancePreview.png){#fig-attendancePreview}\n\n![The `supplies` sheet](../assets/post-assets/2022-02-23-making-pretty-excel-files-in-r/suppliesPreview.png){#fig-suppliesPreview}\n\nA preview of the Attendance and Supplies sheets\n:::\n\n----\n\n# Reading an Existing Workbook\n\nAs usual, the first thing to do is load our library with `library(openxlsx)`. We can try and load the workbook, the Excel file, with `read.xlsx`, but for now we're going to use `loadWorkbook`. This loads a workbook object and exposes some workbook properties to us rather than just the raw data like with `read.xlsx`.\n\n\n\n\n::: {.cell hash='2022-02-23-making-pretty-excel-files-in-r_cache/html/unnamed-chunk-2_a48aa732011426017966806540d3581c'}\n\n```{.r .cell-code}\n# load openxlsx\nlibrary(openxlsx)\n# get the sheet names\nbbq <- loadWorkbook(filePath)\nnames(bbq)\n\n# load the sheets and preview them\nattendance <- readWorkbook(bbq, \"Attendance\")\nhead(attendance)\n\nsupplies <- readWorkbook(bbq, sheet = \"Supplies\")\nhead(supplies)\n```\n:::\n\n\n[1] \"Attendance\" \"Supplies\"  \n\n|      |Name             |RSVPed|Status|FoodPreference|\n|------|-----------------|:----:|------|--------------|\n|1     |Masud Durga      |TRUE  |No    |NA            |\n|2     |Stanislav Zillah |TRUE  |Yes   |Hotdog        |\n|3     |Joaquina Aristide|FALSE |NA    |NA            |\n|4     |Iuppiter Dieu    |TRUE  |Yes   |Hotdog        |\n|5     |Hari Evgenios    |TRUE  |Yes   |Hamburger     |\n|6     |Shaina Gwenaelle |TRUE  |Yes   |Hotdog        |\n\n<center><em style=\"color: grey;\">The attendance data.frame</em></center>\n\n\n|      |SupplyType       |Quantity|PerPackage|PackagesNeeded|Leftover|\n|------|-----------------|:------:|:--------:|:------------:|:------:|\n|1     |Hotdogs          |   34   |    10    |      4       |   6    |\n|2     |Hotdog buns      |   NA   |    8     |      5       |   6    |\n|3     |Hamburgers       |   36   |    6     |      6       |   0    |\n|4     |Hamburger buns   |   NA   |    8     |      5       |   4    |\n\n<center><em style=\"color: grey;\">The supplies data.frame</em></center>\n\n\nBecause we loaded the data as a workbook object, we can use `getStyles` to load the styles and preview them. Unfortunately, the styles can't pull conditional formatting and don't keep track of which cells use which styles. By cross referencing the list of styles and `bbq.xlsx`, we can identify some styles to use and them assign them each to a variable.\n\n\n::: {.cell hash='2022-02-23-making-pretty-excel-files-in-r_cache/html/unnamed-chunk-3_1a3663095f689c255445a8ea6c3ea2fa'}\n\n```{.r .cell-code}\n# getStyles and set them appropriately\nstyles <- getStyles(bbq)\nstyles\n\n# doesn't work for colors because those are conditional formatting\nheaderStyle <- styles[[1]]\nnumberStyle <- styles[[7]]\n```\n:::\n\n\n*I've chosen to only show the first two items from the `styles` list here.*\n\n```\n[[1]]\nA custom cell style. \n\n Cell formatting: GENERAL \n Font name: Calibri \n Font size: 14 \n Font colour: 1 \n Font decoration: BOLD \n \n\n[[2]]\nA custom cell style. \n\n Cell formatting: GENERAL \n Cell horz. align: center\n```\n\n----\n\n# Creating a Workbook\n\nFirst thing we have to do is create a workbook object that we'll call `wb`. We can quickly preview it by just typing `wb` into our chunk or the console.\n\n\n::: {.cell hash='2022-02-23-making-pretty-excel-files-in-r_cache/html/unnamed-chunk-4_a649e5575c1ee9e9b68be3b4e051bafe'}\n\n```{.r .cell-code}\n# create workbook and check contents\nwb <- createWorkbook()\nwb\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nA Workbook object.\n \nWorksheets:\n No worksheets attached\n```\n:::\n:::\n\n\nWe're going to make the `Supplies` sheet first as it's a little bit easier. We first add a new worksheet named `Supplies` to the workbook, then we can write the relevant data to that sheet along with styling our column headers using `headerStyle` from earlier.\n\n\n::: {.cell hash='2022-02-23-making-pretty-excel-files-in-r_cache/html/unnamed-chunk-5_2ff1be158cc51cd04dac4ae07f2cc98b'}\n\n```{.r .cell-code}\n# create the supplies sheet and check for it\naddWorksheet(wb = wb, sheetName = \"Supplies\")\n# write supplies to the worksheet using headerStyle\nwriteData(wb = wb, sheet = \"Supplies\", x = supplies, headerStyle = headerStyle)\n```\n:::\n\n\n# Adding Styles\n\nAll of the numbers in the `Supplies` sheet are centered both horizontally and vertically. We can achieve this by adding the `numberStyle` from before to those cells. `rows` and `cols` both start at 2 because row one is the header row and column one is the supply type. `rows` goes to 5 because there are 4 rows of numbers (remember the header row) and `cols` goes to 5 because there are 4 columns of numbers. `gridExpand = TRUE` makes sure that all cell reference combinations possible with `rows` and `cols` are used, rather than doing an entire row or column.\n\n\n::: {.cell hash='2022-02-23-making-pretty-excel-files-in-r_cache/html/unnamed-chunk-6_15babbb7ddd8ac924164ad54c3459585'}\n\n```{.r .cell-code}\n# add numberStyle\naddStyle(wb = wb, sheet = \"Supplies\", style = numberStyle, rows = 2:5, \n         cols = 2:5, gridExpand = TRUE)\n```\n:::\n\n\nIf we go back to our data in R, the `Quantity` for Hotdog buns and Hamburger buns is empty. A bit further back, we see that that's because those cells were merged with the `Quantity` of Hotdogs and Hamburgers respectively. We can replicate this using `mergeCells`. Unlike `addStyle`, we don't need to use `gridExpand` to merge all the cells as it is implied. `cols` will be 2 for both and we want `rows` 2 and 3 for Hotdogs and `rows` 4 and 5 for Hamburgers.\n\n\n::: {.cell hash='2022-02-23-making-pretty-excel-files-in-r_cache/html/unnamed-chunk-7_e0c380e93fdc0fec5d719a067342190b'}\n\n```{.r .cell-code}\n# merge the hamburger and hotdog quantity cells\nmergeCells(wb = wb, sheet = \"Supplies\", cols = 2, rows = 2:3)\nmergeCells(wb = wb, sheet = \"Supplies\", cols = 2, rows = 4:5)\n```\n:::\n\n\nOur last step on this worksheet is to set the column widths to auto. We again need to specify `cols` and can just do `1:5` so that all columns are affected.\n\n\n::: {.cell hash='2022-02-23-making-pretty-excel-files-in-r_cache/html/unnamed-chunk-8_2b722dbd3384f2ab976ccb1702cbd99e'}\n\n```{.r .cell-code}\n# set column widths to auto\nsetColWidths(wb = wb, sheet = \"Supplies\", cols = 1:5, widths = \"auto\")\n```\n:::\n\n\nOu `Supplies` sheet is now complete, but we're not going to write it just yet because we still need to do the `Attendance` sheet.\n\nLike before, we first add the `Attendance` worksheet and write the data to it.\n\n\n::: {.cell hash='2022-02-23-making-pretty-excel-files-in-r_cache/html/unnamed-chunk-9_1a63a583fdb40ee4a5232ea714707451'}\n\n```{.r .cell-code}\n# create the attendance sheet and check for it\naddWorksheet(wb = wb, sheetName = \"Attendance\")\n\n# write attendance to the worksheet using the same headerStyle from before\nwriteData(wb = wb, sheet = \"Attendance\", x = attendance, \n          headerStyle = headerStyle)\n```\n:::\n\n\n----\n\n# Conditional Formatting\n\nThe `RSVPed` and `Status` columns each have some conditional formatting. We can reuse the color formatting from the `RSVPed` column on the `Status` column, so we're going to separate the color style from the alignment style. It was easy to see how many rows we have in the `Supplies` sheet but not here so we're going to create a new variable that has the `rowNumbers`. Again, we start on row 2 because of the header row and will end at our last data row plus 1.\n\n\n::: {.cell hash='2022-02-23-making-pretty-excel-files-in-r_cache/html/unnamed-chunk-10_1096a7a98f7e2dc499acc00e7b3c0450'}\n\n```{.r .cell-code}\n# create color styles for rsvp and status\ngoodStyle <- createStyle(fontColour = \"#006100\", bgFill = \"#C6EFCE\")\nbadStyle <- createStyle(fontColour = \"#9C0006\", bgFill = \"#FFC7CE\")\n# create center style for rsvp column\ncenterStyle <- createStyle(halign = \"center\")\n\n# create a variable of row numbers\nrowNumbers <- seq(2, nrow(attendance) + 1, by = 1)\n```\n:::\n\n\nOur first step is to center the values in the `RSVPed` column with an `addStyle`. Next, while we could manually color each cell using a `for` loop, it's more efficient to use `conditionalFormatting`. This also has the added bonus of showing in Excel and responding to any changes. The rule argument may be a little strange, and that's because it must match how the same formatting rule would be written in Excel. In this case, we use our top-leftmost cell as the reference cell in the rule, `B2`, then we check if it is `TRUE` or `FALSE`. When the rule is applied down the cells in column `B`, the row number will change to match the current row.\n\n\n::: {.cell hash='2022-02-23-making-pretty-excel-files-in-r_cache/html/unnamed-chunk-11_65a0cb723cbe2678256ecad3c8844cf9'}\n\n```{.r .cell-code}\n# center the column values\naddStyle(wb = wb, sheet = \"Attendance\", \n         style = centerStyle, cols = 2, rows = rowNumbers)\n\n# IF `RSVPed` is TRUE, set it to green. IF FALSE, set it to red\nconditionalFormatting(wb = wb, sheet = \"Attendance\", cols = 2, \n                      rows = rowNumbers, rule = \"B2==TRUE\", style = goodStyle)\nconditionalFormatting(wb = wb, sheet = \"Attendance\", cols = 2, \n                      rows = rowNumbers, rule = \"B2==FALSE\", style = badStyle)\n```\n:::\n\n\nThe `Status` column is very similar to the `RSVPed` column, but we add a style for `Tentative` responses and then need a third `conditionalFormatting`. The newest part here is in the `rule` argument. We need to put quotes around `Yes` so that Excel knows that it is a string and need to use `\\\"` so that R knows that the quote is part of the string. Once our formatting has been applied, we set the column widths as we did before.\n\n\n::: {.cell hash='2022-02-23-making-pretty-excel-files-in-r_cache/html/unnamed-chunk-12_4b8abfd441d3ad2c78f830b9b41c05d9'}\n\n```{.r .cell-code}\n# add style for status and tentative\nmaybeStyle <- createStyle(fontColour = \"#9C6500\", bgFill = \"#FFEB9C\")\n\nconditionalFormatting(wb = wb, sheet = \"Attendance\", cols = 3, \n                      rows = rowNumbers, rule = \"C2==\\\"Yes\\\"\", \n                      style = goodStyle)\nconditionalFormatting(wb = wb, sheet = \"Attendance\", cols = 3, \n                      rows = rowNumbers, rule = \"C2==\\\"No\\\"\", \n                      style = badStyle)\nconditionalFormatting(wb = wb, sheet = \"Attendance\", cols = 3, \n                      rows = rowNumbers, rule = \"C2==\\\"Tentative\\\"\", \n                      style = maybeStyle)\n\n# set column widths to auto\nsetColWidths(wb = wb, sheet = \"Attendance\", cols = 1:4, widths = \"auto\")\n```\n:::\n\n\n----\n\n# Writing the Workbook\n\nThe last thing we need to do is reorder the worksheets so that `Attendance` is first because when we created the workbook in R, we created the `Supplies` worksheet first. Unfortunately, `worksheetOrder` only supports integer vectors. We can check our worksheet numbers by calling the object again through either the chunk or console. Then we set the worksheet order and save the workbook to an `.xlsx` file.\n\n\n::: {.cell hash='2022-02-23-making-pretty-excel-files-in-r_cache/html/unnamed-chunk-13_d7eb5ab34ca4c1b10f2d69fd82f1d5f3'}\n\n```{.r .cell-code}\n# check the workbook sheet order\nwb\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nA Workbook object.\n \nWorksheets:\n Sheet 1: \"Supplies\"\n \n\tCustom column widths (column: width)\n\t  1: auto, 2: auto, 3: auto, 4: auto, 5: auto \n \n\n Sheet 2: \"Attendance\"\n \n\tCustom column widths (column: width)\n\t  1: auto, 2: auto, 3: auto, 4: auto \n \n\n \n Worksheet write order: 1, 2\n Active Sheet 1: \"Supplies\" \n\tPosition: 1\n```\n:::\n\n```{.r .cell-code}\n# change the order\nworksheetOrder(wb) <- c(2, 1)\n\n# save the workbook\nsaveWorkbook(wb, outputPath, overwrite = TRUE)\n```\n:::\n\n\nIf we open the new file, we can see that they are nearly identical. The biggest difference between the two is that the original used formulas to calculate the values in `Supplies`.\n\nIf you did want to take it a step further and use those instead, the `writeFormula` function is your friend. In any case, I highly encourage everyone to at least skim through the `openxlsx` documentation [here](https://cran.r-project.org/web/packages/openxlsx/openxlsx.pdf) because it has so much to offer to help streamline Excel file generation.\n\n----\n\nAll the code for this article is available [here](https://gist.github.com/guslipkin/bc0b1ab7861c431a08b8672bec50d806?file=openxlsxUsage.rmd). If you want to see more from me, check out [my GitHub](https://github.com/guslipkin) or [guslipkin.github.io](https://guslipkin.github.io). If you want to hear from me, I'm also on Twitter [@guslipkin](https://twitter.com/GusLipkin).\n\n<center><em>Gus Lipkin is a Data Scientist, Business Analyst, and occasional bike mechanic</em></center>\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}