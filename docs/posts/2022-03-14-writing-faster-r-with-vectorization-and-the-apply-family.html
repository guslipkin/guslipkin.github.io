<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.179">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Gus Lipkin">
<meta name="dcterms.date" content="2022-03-14">
<meta name="description" content="Learning when and how to use for loops, the apply family, and vectorization to write fast code in R">

<title>Gus Lipkin’s Awesome Website - Writing Faster R With Vectorization and the Apply Family</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Gus Lipkin’s Awesome Website</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html">About Me</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../resume.html">My Résumé</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../blog.html">My Blog</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../contact.html">Contact Me</a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/guslipkin/"><i class="bi bi-linkedin" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.github.com/guslipkin"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.twitter.com/GusLipkin"><i class="bi bi-twitter" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#intro" id="toc-intro" class="nav-link active" data-scroll-target="#intro">Intro</a></li>
  <li><a href="#what-is-an" id="toc-what-is-an" class="nav-link" data-scroll-target="#what-is-an">What is a(n)…</a>
  <ul class="collapse">
  <li><a href="#for-loop" id="toc-for-loop" class="nav-link" data-scroll-target="#for-loop"><code>for</code> loop</a></li>
  <li><a href="#apply-family" id="toc-apply-family" class="nav-link" data-scroll-target="#apply-family"><code>apply</code> family</a></li>
  <li><a href="#vector-operations" id="toc-vector-operations" class="nav-link" data-scroll-target="#vector-operations">Vector Operations</a></li>
  </ul></li>
  <li><a href="#when-should-i-use-an" id="toc-when-should-i-use-an" class="nav-link" data-scroll-target="#when-should-i-use-an">When should I use a(n)…</a>
  <ul class="collapse">
  <li><a href="#for-loop-1" id="toc-for-loop-1" class="nav-link" data-scroll-target="#for-loop-1"><code>for</code> loop</a></li>
  <li><a href="#apply-family-1" id="toc-apply-family-1" class="nav-link" data-scroll-target="#apply-family-1"><code>apply</code> family</a></li>
  <li><a href="#vector-operations-1" id="toc-vector-operations-1" class="nav-link" data-scroll-target="#vector-operations-1">Vector Operations</a></li>
  </ul></li>
  <li><a href="#benchmarks" id="toc-benchmarks" class="nav-link" data-scroll-target="#benchmarks">Benchmarks</a>
  <ul class="collapse">
  <li><a href="#building-the-input" id="toc-building-the-input" class="nav-link" data-scroll-target="#building-the-input">Building the input</a></li>
  <li><a href="#creating-the-conversion-function" id="toc-creating-the-conversion-function" class="nav-link" data-scroll-target="#creating-the-conversion-function">Creating the conversion function</a></li>
  <li><a href="#implementing-the-conversion-function" id="toc-implementing-the-conversion-function" class="nav-link" data-scroll-target="#implementing-the-conversion-function">Implementing the conversion function</a>
  <ul class="collapse">
  <li><a href="#in-a-for-loop" id="toc-in-a-for-loop" class="nav-link" data-scroll-target="#in-a-for-loop">In a <code>for</code> loop</a></li>
  <li><a href="#in-an-apply-function" id="toc-in-an-apply-function" class="nav-link" data-scroll-target="#in-an-apply-function">In an <code>apply</code> function</a></li>
  <li><a href="#in-a-vectorized-function" id="toc-in-a-vectorized-function" class="nav-link" data-scroll-target="#in-a-vectorized-function">In a vectorized function</a></li>
  <li><a href="#the-results" id="toc-the-results" class="nav-link" data-scroll-target="#the-results">The results</a></li>
  </ul></li>
  <li><a href="#running-the-benchmark" id="toc-running-the-benchmark" class="nav-link" data-scroll-target="#running-the-benchmark">Running the benchmark</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Writing Faster R With Vectorization and the Apply Family</h1>
  <div class="quarto-categories">
    <div class="quarto-category">R</div>
    <div class="quarto-category">R: apply</div>
  </div>
  </div>

<div>
  <div class="description">
    Learning when and how to use for loops, the apply family, and vectorization to write fast code in R
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Gus Lipkin </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">March 14, 2022</p>
    </div>
  </div>
    
  </div>
  

</header>

<p><a href="https://guslipkin.medium.com/writing-faster-r-with-vectorization-and-the-apply-family-ff6078a2583a"><em>Link to the Medium post</em></a></p>
<section id="intro" class="level1">
<h1>Intro</h1>
<p>One of my favorite things about R is that there are a lot of ways to do the same thing. Of course, this means that some ways are better than others depending on the use case. <code>for</code> loops, the <code>apply</code> family, and vectorization are all common ways to write code for large amounts of data in R, but it can be tricky to know when to use each one and how to use them.</p>
<p>I’ve divided this post into how to use each method in R and then give a few examples of when you might want to use each one. I close everything out with a short benchmark demonstration to compare the three.</p>
<hr>
</section>
<section id="what-is-an" class="level1">
<h1>What is a(n)…</h1>
<section id="for-loop" class="level2">
<h2 class="anchored" data-anchor-id="for-loop"><code>for</code> loop</h2>
<p><em>If you’re familiar with programming, you can probably skip this section.</em></p>
<p>A for loop lets you run the same code a specified number of times. The structure generally follows <code>for(x in y)</code> where <code>x</code> represents an item in <code>y</code>. If we think about a shopping basket with some apples, bananas, and carrots, we could write <code>for(food in basket)</code> and food would represent each item in our basket. It would be apples the first time, bananas the second time, and carrots the third time. We could also write it as <code>for(food in 1:length(basket))</code> where <code>1:length(basket)</code> is a vector of numbers that counts the items in your basket. Rather than food representing an item in your basket, it represents an index in the vector. In this example, apples are at index 1, bananas at 2, and carrots at 3. <code>for</code> loops are also very flexible and can be used on many data types such as vectors, data.frames, and matrices.</p>
<p>Let’s say you have a <code>data.frame</code> called <code>basket</code> that has three columns. It has the <code>Food</code> column with the name of the food, the <code>PricePerUnit</code> which has the unit cost for each food, and <code>Quantity</code> which has the number of units of each food in your basket. It looks like this:</p>
<table class="table">
<thead>
<tr class="header">
<th>Food</th>
<th>PricePerUnit</th>
<th>Quantity</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Apples</td>
<td>0.99</td>
<td>12</td>
</tr>
<tr class="even">
<td>Bananas</td>
<td>0.19</td>
<td>6</td>
</tr>
<tr class="odd">
<td>Carrots</td>
<td>0.49</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>And it can be recreated with this:</p>
<div class="cell" data-hash="2022-03-14-writing-faster-r-with-vectorization-and-the-apply-family_cache/html/unnamed-chunk-1_94ca274f315f29899eab60dbfacdf997">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>basket <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="st">"Food"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Apples"</span>, <span class="st">"Bananas"</span>, <span class="st">"Carrots"</span>),</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"PricePerUnit"</span> <span class="ot">=</span> <span class="fu">c</span>(.<span class="dv">99</span>, .<span class="dv">19</span>, .<span class="dv">49</span>),</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Quantity"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">12</span>, <span class="dv">6</span>, <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If we wanted to get the total cost of everything in our basket, we could iterate over each row multiplying the <code>PricePerUnit</code> and <code>Quantity</code> and adding those to our running totals.</p>
<div class="cell" data-hash="2022-03-14-writing-faster-r-with-vectorization-and-the-apply-family_cache/html/unnamed-chunk-2_b99f88774c6d082dc0362f94c30a2ac6">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create the total</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>total <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># loop over the data.frame and add the running total</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(row <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(basket))</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  total <span class="ot">&lt;-</span> total <span class="sc">+</span> (basket<span class="sc">$</span>PricePerUnit[row] <span class="sc">*</span> basket<span class="sc">$</span>Quantity[row])</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>total</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 14</code></pre>
</div>
</div>
</section>
<section id="apply-family" class="level2">
<h2 class="anchored" data-anchor-id="apply-family"><code>apply</code> family</h2>
<p>The <code>apply</code> family is part of base R and very similar to a for loop. Rather than running a set number of times, an <code>apply</code> runs a function on each item in a <code>data.frame</code>, <code>list</code>, <code>vector</code>, or other object that can be applied to. While there are six different functions in the <code>apply</code> family, I’m only going to talk about the three most common; <code>apply</code>, <code>lapply</code>, and <code>sapply</code>.</p>
<p>The biggest differences between the three is the types of input that they accept and their output types. <code>apply</code> takes in a <code>data.frame</code> or matrix and has three function arguments. The first argument, <code>x</code>, is the object we’re passing to it. The second argument is a number, either 1 or 2 or <code>c(1, 2)</code>, that says if we want the function applied to rows, columns, or both rows and columns, respectively. The last argument is the function call. <code>sapply</code> and <code>lapply</code> are the same, except they don’t have the second argument because they take either a vector or list which don’t have multiple dimensions. Generally speaking, the <code>apply</code> family will return a vector, list, or array of some kind.</p>
<p>If we go back to the shopping basket example, we can calculate the total with an <code>apply</code> function. Our first argument is the <code>basket</code>, the second is a <code>1</code> because we want to <code>apply</code> to every row, and the last is the function call. We can create the function in the <code>apply</code> call or we can create it earlier and then call it here.</p>
<div class="cell" data-hash="2022-03-14-writing-faster-r-with-vectorization-and-the-apply-family_cache/html/unnamed-chunk-3_2de6a06b97cafba9dfd4627c61c7f8ff">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># multiply each PricePerUnit and Quantity and store the resulting vector</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>perItemTotal <span class="ot">&lt;-</span> <span class="fu">apply</span>(basket, <span class="dv">1</span>, <span class="cf">function</span>(bskt) {</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.numeric</span>(bskt[<span class="st">"PricePerUnit"</span>]) <span class="sc">*</span> <span class="fu">as.numeric</span>(bskt[<span class="st">"Quantity"</span>])</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># sum all values in the perItemTotal</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(perItemTotal)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 14</code></pre>
</div>
</div>
<p><strong>A quick note on function calls in the apply family:</strong></p>
<p>If a function call only has one argument, they can be done in three ways. 1. <code>sapply(X, function(x) { ... })</code> if function is not predefined 2. <code>sapply(X, function)</code> if function is predefined 3. <code>sapply(X, function(x))</code> if function is predefined</p>
<p>Option two is most common for built-in functions such as <code>sum</code> or <code>as.numeric</code>, but can be used with any function.</p>
</section>
<section id="vector-operations" class="level2">
<h2 class="anchored" data-anchor-id="vector-operations">Vector Operations</h2>
<p>Vector operations are not a function like the <code>apply</code> family or a <code>for</code> loop, but rather a feature of the R language. Instead of operating on a vector one item at a time, R is able to do an operation on the entire vector in one line of code. Back to the basket example again, we know that the per item total is the <code>PricePerUnit</code> and <code>Quantity</code> multiplied together, and then we get the grand total by summing all of those values.</p>
<div class="cell" data-hash="2022-03-14-writing-faster-r-with-vectorization-and-the-apply-family_cache/html/unnamed-chunk-4_3d9b83a8a4ef449c1d581b8b1cb26eca">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># take the sum of multiplying PerPriceUnit and Quantity to get total cost</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(basket<span class="sc">$</span>PricePerUnit <span class="sc">*</span> basket<span class="sc">$</span>Quantity)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 14</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="when-should-i-use-an" class="level1">
<h1>When should I use a(n)…</h1>
<p>These examples are not exhaustive and you may find some cases where one is better than the others even where it seems like it might not be.</p>
<section id="for-loop-1" class="level2">
<h2 class="anchored" data-anchor-id="for-loop-1"><code>for</code> loop</h2>
<p><code>for</code> loops in R should be a last resort. They are much slower compared to the apply family and vectorized code. They may be helpful when each iteration relies on the iteration before it, although then you might want to look into a recursive function if possible. You might find a <code>for</code> loop useful if you need to run the same block of code multiple times or iterate over elements of an object in a non-standard way such as every other item. Any code that can be written with an <code>apply</code> function or a vector operation can be written in a <code>for</code> loop.</p>
</section>
<section id="apply-family-1" class="level2">
<h2 class="anchored" data-anchor-id="apply-family-1"><code>apply</code> family</h2>
<p>The <code>apply</code> family should be used when you want to operate on each element of an object, but treat them individually. This might present as a list with vectors of differing lengths for each item or if you want a specific type of output. Any vector operation can be written as an <code>apply</code> statement, but not all <code>for</code> loops can be converted.</p>
</section>
<section id="vector-operations-1" class="level2">
<h2 class="anchored" data-anchor-id="vector-operations-1">Vector Operations</h2>
<p>Vector operations are the gold standard. They are fast and can be used in many cases, but not all. Most common use cases will be on vectors or columns of a <code>data.frame</code>. Many base functions such as <code>sum</code> and <code>as.numeric</code> are already vectorized. Many but not all <code>for</code> loops and <code>apply</code> functions can be written as vectorized operations.</p>
<hr>
</section>
</section>
<section id="benchmarks" class="level1">
<h1>Benchmarks</h1>
<section id="building-the-input" class="level2">
<h2 class="anchored" data-anchor-id="building-the-input">Building the input</h2>
<p>Rather than use the simple shopping basket example from before, I’ve written a small function that takes a <code>data.frame</code> of red, green, and blue values and adds a new column with the corresponding hex code.</p>
<div class="cell" data-hash="2022-03-14-writing-faster-r-with-vectorization-and-the-apply-family_cache/html/unnamed-chunk-5_d98531fdf48c4699f0974f27f1cdce85">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a vector of the possible hex code values (0-9 and A-F)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>hex <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">9</span>, LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>])</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># set the seed</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2022</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co"># pick the number of rows</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>rows <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">^</span><span class="dv">4</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co"># create a data.frame of rgb values</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="st">"red"</span> <span class="ot">=</span> <span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">255</span>, rows, <span class="at">replace =</span> <span class="cn">TRUE</span>), </span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"green"</span> <span class="ot">=</span> <span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">255</span>, rows, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"blue"</span> <span class="ot">=</span> <span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">255</span>, rows, <span class="at">replace =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And the resulting data should look like this:</p>
<table class="table">
<thead>
<tr class="header">
<th>red</th>
<th>green</th>
<th>blue</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>227</td>
<td>18</td>
<td>84</td>
</tr>
<tr class="even">
<td>178</td>
<td>245</td>
<td>26</td>
</tr>
<tr class="odd">
<td>205</td>
<td>219</td>
<td>176</td>
</tr>
<tr class="even">
<td>54</td>
<td>236</td>
<td>205</td>
</tr>
<tr class="odd">
<td>74</td>
<td>252</td>
<td>67</td>
</tr>
<tr class="even">
<td>195</td>
<td>116</td>
<td>122</td>
</tr>
</tbody>
</table>
<p>We’ve also created a vector of values that can go in a hex code with numbers 0–9 and letters A-F.</p>
</section>
<section id="creating-the-conversion-function" class="level2">
<h2 class="anchored" data-anchor-id="creating-the-conversion-function">Creating the conversion function</h2>
<p>I used <a href="https://www.developintelligence.com/blog/2017/02/rgb-to-hex-understanding-the-major-web-color-codes/">this website</a> for the math behind my functions. In essence, you divide each number by <code>16</code> and round down and the resulting number corresponds to a position in hex. You then take the remainder of the division and get the hex value that that number corresponds to. If our value is <code>227</code>, then our first hex code is <code>227/16</code> would round down to <code>14</code> and the remainder would be <code>3</code>. Because vectors in R start at position <code>1</code>, we add one to both for <code>15</code> and <code>4</code>. The corresponding values in hex are <code>E</code> and <code>3</code> and so the hex pair for <code>227</code> is <code>E3</code>.</p>
</section>
<section id="implementing-the-conversion-function" class="level2">
<h2 class="anchored" data-anchor-id="implementing-the-conversion-function">Implementing the conversion function</h2>
<section id="in-a-for-loop" class="level3">
<h3 class="anchored" data-anchor-id="in-a-for-loop">In a <code>for</code> loop</h3>
<div class="cell" data-hash="2022-03-14-writing-faster-r-with-vectorization-and-the-apply-family_cache/html/unnamed-chunk-6_18cca8dd47623aeec7ca488befc62293">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># iterate over each row in df</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(r <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df)) {</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get a value for each position in the hex code</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># first pair</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  h1 <span class="ot">&lt;-</span> hex[<span class="fu">floor</span>(df<span class="sc">$</span>red[r] <span class="sc">/</span> <span class="dv">16</span>) <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  h2 <span class="ot">&lt;-</span> hex[df<span class="sc">$</span>red[r] <span class="sc">%%</span> <span class="dv">16</span> <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># second pair</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  h3 <span class="ot">&lt;-</span> hex[<span class="fu">floor</span>(df<span class="sc">$</span>green[r] <span class="sc">/</span> <span class="dv">16</span>) <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  h4 <span class="ot">&lt;-</span> hex[df<span class="sc">$</span>green[r] <span class="sc">%%</span> <span class="dv">16</span> <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># third pair</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  h5 <span class="ot">&lt;-</span> hex[<span class="fu">floor</span>(df<span class="sc">$</span>blue[r] <span class="sc">/</span> <span class="dv">16</span>) <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  h6 <span class="ot">&lt;-</span> hex[df<span class="sc">$</span>blue[r] <span class="sc">%%</span> <span class="dv">16</span> <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># assemble the values using `paste0` and assign it to the `hex` column for </span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># the corresponding row</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>hex[r] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"#"</span>, h1, h2, h3, h4, h5, h6)</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="in-an-apply-function" class="level3">
<h3 class="anchored" data-anchor-id="in-an-apply-function">In an <code>apply</code> function</h3>
<div class="cell" data-hash="2022-03-14-writing-faster-r-with-vectorization-and-the-apply-family_cache/html/unnamed-chunk-7_3fca48f4bdddab6dffceb1257372d215">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df[, <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"green"</span>, <span class="st">"blue"</span>)]</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># create the rgbToHex function that takes a named vector and returns a hex code</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>rgbToHex <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get a value for each position in the hex code</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># first pair</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  h1 <span class="ot">&lt;-</span> hex[<span class="fu">floor</span>(x[<span class="st">"red"</span>] <span class="sc">/</span> <span class="dv">16</span>) <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  h2 <span class="ot">&lt;-</span> hex[x[<span class="st">"red"</span>] <span class="sc">%%</span> <span class="dv">16</span> <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># second pair</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  h3 <span class="ot">&lt;-</span> hex[<span class="fu">floor</span>(x[<span class="st">"green"</span>] <span class="sc">/</span> <span class="dv">16</span>) <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  h4 <span class="ot">&lt;-</span> hex[x[<span class="st">"green"</span>] <span class="sc">%%</span> <span class="dv">16</span> <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># third pair</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  h5 <span class="ot">&lt;-</span> hex[<span class="fu">floor</span>(x[<span class="st">"blue"</span>] <span class="sc">/</span> <span class="dv">16</span>) <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  h6 <span class="ot">&lt;-</span> hex[x[<span class="st">"blue"</span>] <span class="sc">%%</span> <span class="dv">16</span> <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># assemble and return the hex code</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste0</span>(<span class="st">"#"</span>, h1, h2, h3, h4, h5, h6)</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="co"># call `rgbToHex` and apply it to each row in df</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>hex <span class="ot">&lt;-</span> <span class="fu">apply</span>(df, <span class="dv">1</span>, rgbToHex)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="in-a-vectorized-function" class="level3">
<h3 class="anchored" data-anchor-id="in-a-vectorized-function">In a vectorized function</h3>
<div class="cell" data-hash="2022-03-14-writing-faster-r-with-vectorization-and-the-apply-family_cache/html/unnamed-chunk-8_f2e006f9b634b899f3a6cf1675e2916b">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># paste the calculated hex codes into the new `hex` column in df</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>hex <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"#"</span>, </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                 hex[<span class="fu">floor</span>(df<span class="sc">$</span>red <span class="sc">/</span> <span class="dv">16</span>) <span class="sc">+</span> <span class="dv">1</span>],</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                 hex[df<span class="sc">$</span>red <span class="sc">%%</span> <span class="dv">16</span> <span class="sc">+</span> <span class="dv">1</span>],</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>                 hex[<span class="fu">floor</span>(df<span class="sc">$</span>green <span class="sc">/</span> <span class="dv">16</span>) <span class="sc">+</span> <span class="dv">1</span>],</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>                 hex[df<span class="sc">$</span>green <span class="sc">%%</span> <span class="dv">16</span> <span class="sc">+</span> <span class="dv">1</span>],</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>                 hex[<span class="fu">floor</span>(df<span class="sc">$</span>blue <span class="sc">/</span> <span class="dv">16</span>) <span class="sc">+</span> <span class="dv">1</span>],</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>                 hex[df<span class="sc">$</span>blue <span class="sc">%%</span> <span class="dv">16</span> <span class="sc">+</span> <span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="the-results" class="level3">
<h3 class="anchored" data-anchor-id="the-results">The results</h3>
<table class="table">
<thead>
<tr class="header">
<th>red</th>
<th>green</th>
<th>blue</th>
<th>hex</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>227</td>
<td>18</td>
<td>84</td>
<td>#E31254</td>
</tr>
<tr class="even">
<td>178</td>
<td>245</td>
<td>26</td>
<td>#B2F51A</td>
</tr>
<tr class="odd">
<td>205</td>
<td>219</td>
<td>176</td>
<td>#CDDBB0</td>
</tr>
<tr class="even">
<td>54</td>
<td>236</td>
<td>205</td>
<td>#36ECCD</td>
</tr>
<tr class="odd">
<td>74</td>
<td>252</td>
<td>67</td>
<td>#4AFC43</td>
</tr>
<tr class="even">
<td>195</td>
<td>116</td>
<td>122</td>
<td>#C3747A</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="running-the-benchmark" class="level2">
<h2 class="anchored" data-anchor-id="running-the-benchmark">Running the benchmark</h2>
<p>I’ve simplified the <code>for</code> loop and <code>apply</code> implementations a little bit to better match the vectorized function. This way we have a better comparison between the three. Your benchmark results may be a little different because it is a little dependent on your computer.</p>
<div class="cell" data-hash="2022-03-14-writing-faster-r-with-vectorization-and-the-apply-family_cache/html/unnamed-chunk-9_40d25a17bc6ed2c99734e0cd7b22b224">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>rows <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">^</span><span class="dv">4</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>hex <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">9</span>, LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>])</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2022</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="st">"red"</span> <span class="ot">=</span> <span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">255</span>, rows, <span class="at">replace =</span> <span class="cn">TRUE</span>), </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"green"</span> <span class="ot">=</span> <span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">255</span>, rows, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"blue"</span> <span class="ot">=</span> <span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">255</span>, rows, <span class="at">replace =</span> <span class="cn">TRUE</span>))</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>rbenchmark<span class="sc">::</span><span class="fu">benchmark</span>(</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"for loop"</span> <span class="ot">=</span> {</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    df <span class="ot">&lt;-</span> dt</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (r <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df)) {</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>      df<span class="sc">$</span>hexFor[r] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"#"</span>, </span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>                             hex[<span class="fu">floor</span>(df<span class="sc">$</span>red[r] <span class="sc">/</span> <span class="dv">16</span>) <span class="sc">+</span> <span class="dv">1</span>],</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>                             hex[df<span class="sc">$</span>red[r] <span class="sc">%%</span> <span class="dv">16</span> <span class="sc">+</span> <span class="dv">1</span>],</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>                             hex[<span class="fu">floor</span>(df<span class="sc">$</span>green[r] <span class="sc">/</span> <span class="dv">16</span>) <span class="sc">+</span> <span class="dv">1</span>],</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>                             hex[df<span class="sc">$</span>green[r] <span class="sc">%%</span> <span class="dv">16</span> <span class="sc">+</span> <span class="dv">1</span>],</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>                             hex[<span class="fu">floor</span>(df<span class="sc">$</span>blue[r] <span class="sc">/</span> <span class="dv">16</span>) <span class="sc">+</span> <span class="dv">1</span>],</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>                             hex[df<span class="sc">$</span>blue[r] <span class="sc">%%</span> <span class="dv">16</span> <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>                             )</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">"apply"</span> <span class="ot">=</span> {</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    df <span class="ot">&lt;-</span> dt</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    rgbToHex <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste0</span>(<span class="st">"#"</span>,</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>             hex[<span class="fu">floor</span>(x[<span class="st">"red"</span>] <span class="sc">/</span> <span class="dv">16</span>) <span class="sc">+</span> <span class="dv">1</span>],</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>             hex[x[<span class="st">"red"</span>] <span class="sc">%%</span> <span class="dv">16</span> <span class="sc">+</span> <span class="dv">1</span>],</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>             hex[<span class="fu">floor</span>(x[<span class="st">"green"</span>] <span class="sc">/</span> <span class="dv">16</span>) <span class="sc">+</span> <span class="dv">1</span>],</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>             hex[x[<span class="st">"green"</span>] <span class="sc">%%</span> <span class="dv">16</span> <span class="sc">+</span> <span class="dv">1</span>],</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>             hex[<span class="fu">floor</span>(x[<span class="st">"blue"</span>] <span class="sc">/</span> <span class="dv">16</span>) <span class="sc">+</span> <span class="dv">1</span>],</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>             hex[x[<span class="st">"blue"</span>] <span class="sc">%%</span> <span class="dv">16</span> <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>             )</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>hexApply <span class="ot">&lt;-</span> <span class="fu">apply</span>(df, <span class="dv">1</span>, rgbToHex)</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>  <span class="st">"vector"</span> <span class="ot">=</span> {</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    df <span class="ot">&lt;-</span> dt</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>hexVector <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"#"</span>,</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>                           hex[<span class="fu">floor</span>(df<span class="sc">$</span>red <span class="sc">/</span> <span class="dv">16</span>) <span class="sc">+</span> <span class="dv">1</span>],</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>                           hex[df<span class="sc">$</span>red <span class="sc">%%</span> <span class="dv">16</span> <span class="sc">+</span> <span class="dv">1</span>],</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>                           hex[<span class="fu">floor</span>(df<span class="sc">$</span>green <span class="sc">/</span> <span class="dv">16</span>) <span class="sc">+</span> <span class="dv">1</span>],</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>                           hex[df<span class="sc">$</span>green <span class="sc">%%</span> <span class="dv">16</span> <span class="sc">+</span> <span class="dv">1</span>],</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>                           hex[<span class="fu">floor</span>(df<span class="sc">$</span>blue <span class="sc">/</span> <span class="dv">16</span>) <span class="sc">+</span> <span class="dv">1</span>],</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>                           hex[df<span class="sc">$</span>blue <span class="sc">%%</span> <span class="dv">16</span> <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>                           )</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">replications =</span> <span class="dv">10</span>, <span class="at">order =</span> <span class="st">"relative"</span></span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>) <span class="ot">-&gt;</span> benches</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<table class="table">
<colgroup>
<col style="width: 10%">
<col style="width: 16%">
<col style="width: 10%">
<col style="width: 11%">
<col style="width: 12%">
<col style="width: 11%">
<col style="width: 13%">
<col style="width: 12%">
</colgroup>
<thead>
<tr class="header">
<th>test</th>
<th>replications</th>
<th>elapsed</th>
<th>relative</th>
<th>user.self</th>
<th>sys.self</th>
<th>user.child</th>
<th>sys.child</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>vector</td>
<td>10</td>
<td>0.026</td>
<td>1.000</td>
<td>0.025</td>
<td>0.000</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>apply</td>
<td>10</td>
<td>0.536</td>
<td>20.615</td>
<td>0.530</td>
<td>0.006</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td>forloop</td>
<td>10</td>
<td>1.569</td>
<td>60.346</td>
<td>1.252</td>
<td>0.317</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>
<p>The important column is relative as that shows a comparison between the three with the quickest function given a value of 1. Using an <code>apply</code> function took roughly 20x longer and a <code>for</code> loop roughly 60x longer than using a vectorized function.</p>
<p><img src="../assets/post-assets/2022-03-14-writing-faster-r-with-vectorization-and-the-apply-family/sonic.jpeg" class="img-fluid" alt="A hand drawn Sonic the Hedgehog saying “Gotta go fast”"></p>
<hr>
<p>All code used in this article is available <a href="https://gist.github.com/guslipkin/f21dc766bac769ef69c220fe476306b4#file-basket-csv?file=vectorise.rmd">here</a>. If you want to see more from me, check out <a href="https://github.com/guslipkin">my GitHub</a> or <a href="https://guslipkin.github.io">guslipkin.github.io</a>. If you want to hear from me, I’m also on Twitter <a href="https://twitter.com/GusLipkin"><span class="citation" data-cites="guslipkin">@guslipkin</span></a>.</p>
<center>
<em>Gus Lipkin is a Data Scientist, Business Analyst, and occasional bike mechanic</em>
</center>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } 
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>